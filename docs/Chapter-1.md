# Chapter 1: AWS EC2 Sample Deployment

## Introduction
This document provides detailed, step-by-step instructions on creating a new AWS EC2 instance and deploying a provided Symfony2 application on it using LAMP (Linux, Apache, MySQL, PHP) stack. The application also uses a separate Redis database for certain parts of it, but the connection to Redis is not included in these instructions. These instructions are detailed for use with Mac OS; however, once logged onto the virtual machine provided by your EC2, the instructions are universal. The provided application is a website call “Spoutlet” and it will be cloned from an online github repository.

## Sign up for AWS Free Tier 
1. Sign up for Free Cloud Services – AWS Free Tier https://aws.amazon.com/free/
1. ```AWS Free Tier includes offers that expire 12 months following sign up and others that never expire.```

## Create AWS EC2 instance
1. Log into AWS console and select ```Services``` > ```EC2```
1. Click on ```Instances```

## Launch Instance
1. Click on ```Launch Instance```
1. Select ```Ubuntu Server 16.04...```
1. Select the t2.medium size instance - VERY IMPORTANT
   - click Next until you reach ```Step 6: Configure Security Groups```
   - Or Click on the “Step 6: Configure Security Groups” tab, located along the top of the screen.
1. Change “security group name” to “spoutlet - sample deployment”
1. Click “Add Rule”
   - Add ```Custom TCP Rule``` with ```Port Range = 8000```
   - Change ```Source``` drop down menu to ```Anywhere```
   - Add ```Custom TCP Rule``` with ```Port Range = 0```
   - Change ```Source``` drop down menu to ```Anywhere```
1. Click ```Add Rule```
   - Add ```HTTP```
   - Change ```Source``` drop down menu to ```Anywhere```
1. Click ```Review and Launch```, then review settings and click “Launch”
1. A pop up window will appear asking about a security key
   - Select ```Create a new key pair``` from the first drop down box
   - Enter ```spoutlet_sampleEC2``` for the key pair name, then ```Download Key Pair```
   - IMPORTANT: after downloading the key, place it in a safe and accessible place (perhaps create a backup copy and store it in the cloud); if lost, your key cannot be replaced, as AWS does not store your key after its creation
1. After storing your key in a safe and secure location, click “Launch Instances”
##  Update Folder Permissions
1. Type ```sudo setfacl -R -m u:www-data:rX spoutlet2``` and hit enter
1. Type ```sudo setfacl -R -m u:www-data:rwX spoutlet2/app/cache spoutlet2/app/logs``` and hit enter
1. Type ```sudo setfacl -dR -m u:www-data:rwX spoutlet2/app/cache spoutlet2/app/logs``` and hit enter
1. Type ```export SYMFONY_ENV=prod``` and hit enter
##  Update Spoutlet Project Requirements
1. Open and edit the file ```app/AppKernel.php``` in the spoutlet2 directory
   > cd spoutlet2
   > sudo vi app/AppKernel.php
   - and comment out the line “$bundles[] = new Sensio\Bundle\GeneratorBundle\SensioGeneratorBundle();” by adding two forward slashes in front of it  (“//”)
## Connect to Instance from AWS console
1. After launching instance, return to running instances by clicking on ```Services``` > ```EC2```
1. Click on ```Instances```
   - You should see your deployed instance with ```Initializing``` status under ```Status Checks```
   - Rename the instance to ```Spoutlet Sample```
1. Select your instance and click ```Connect```, this should launch a pop up window with instructions
## Connect to Instance from Terminal
1. With Terminal  / MacOS, From Termnal: 
> chmod 400 spoutlet.publickey
> ssh -i "spoutlet.pem" ubuntu@ec2-54-193-37-203.us-west-1.compute.amazonaws.com
1. With PuTTY / Windows 
   - Connecting to Your Linux Instance from Windows Using PuTTY https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/putty.html 
   - Convert the .pem file to a .ppk file
   - PuTTY does not natively support the private key format (.pem) generated by Amazon EC2. PuTTY has a tool named PuTTYgen, which can convert keys to the required PuTTY format (.ppk). You must convert your private key into this format (.ppk) before attempting to connect to your instance using PuTTY.
   - To convert your key from Public to Private (ppk to pem)
      - Start PuTTYgen (for example, from the Start menu, choose All Programs > PuTTY > PuTTYgen).            
      - Under Type of key to generate, choose RSA.    
      - If you're using an older version of PuTTYgen, choose SSH-2 RSA.                    
      - Choose Load. By default, PuTTYgen displays only files with the extension .ppk. To locate your .pem file, select the option to display files of all types. 
      - Select your .pem file for the key pair that you specified when you launch your instance, and then choose                             Open. Choose OK to dismiss the confirmation dialog box.                    
      - Choose Save private key to save the key in the format that PuTTY can use. PuTTYgen displays a warning about saving the key without a passphrase. Choose Yes.
      - Note
         - A passphrase on a private key is an extra layer of protection, so even if your private key is discovered, it can't be used without the passphrase. The downside to using a passphrase is that it makes automation harder because human intervention is needed to log on to an instance, or copy files to an instance                    
       - Specify the same name for the key that you used for the key pair (for example, my-key-pair). PuTTY automatically adds the .ppk file extension. Your private key is now in the correct format for use with PuTTY. You can now connect to your instance using PuTTY's SSH client.
1. Open a terminal window and navigate into the directory where you placed your ```spoutlet_sampleEC2.pem``` key (downloaded in step 2h)
     - Add privacy restrictions to your key by typing ```chmod 400 spoutlet_sampleEC2.pem``` on command line and hit enter
     - Launch virtual machine via ssh by typing ```ssh -i "spoutlet_sampleEC2.pem" ubuntu@*your-instance*.compute.amazonaws.com``` on command line and hit enter . You can copy the above line under ```example``` from the ```Connect to your instance``` pop up window on your aws console and paste it in your terminal
     - You will be asked if you are sure you want to continue, type “yes” and hit enter
    - You should now be connected to your EC2 instance via a Virtual Machine in your terminal window (your username in the terminal window should now be ```ubuntu@ip-*your-ip*```   
### Install php and composer
1. Install php and composer
   - Install composer by pasting the following line into your terminal and pressing enter:
> sudo apt-get update
> sudo apt-get install php 
> sudo curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
1. Install Apache, MySQL, PHP on your Linux instance
   - Install Apache
     - Type ```sudo apt-get update``` and hit enter
     - Type ```sudo apt-get install apache2``` and hit enter
     - Type ```y``` and hit enter when you are asked if you would like to continue
     - To make sure everything is working, type ```apache2ctl configtest``` on the command line and hit enter
     - You should get an output of ```Syntax OK```
     - Check that your firewall allows web traffic from HTTP and HTTPS
     - Type ```sudo ufw app info "Apache Full"``` and hit enter
        - Your output should show 80 and 443 under ```Ports:``` at the bottom of output
   - Install MySQL
      - Type ```sudo apt-get install mysql-server```
      - Type ```y``` and hit enter when asked if you would like to continue
      - You will be prompted to create a password for the MySQL root user, choose a password that you will remember and hit enter, then repeat it and hit enter
      - Run secure install to improve security and other settings
      - Type ```sudo mysql_secure_installation```
      - Enter the password for ```root``` you chose earlier
      - For ```VALIDATE PASSWORD PLUGIN```: type n and press enter
      - ```Change the password for root?``` type n and press enter
      - ```Remove anonymous users?``` type y and press enter
      - ```Disallow root login remotely?``` type n and press enter
      - ```Remove test database and access to it?``` type n and press enter
      - ```Reload privilege tables now?``` type y and press enter
   - Install PHP
      - Type ```sudo apt-get install php libapache2-mod-php php-mcrypt php-mysql``` and hit enter
    - Restart apache by typing ```sudo systemctl restart apache2``` and hit enter
    - Test that you have successfully installed LAMP
      - Copy your instance’s ```Public DNS``` from the aws console (should look something like ```ec2-54-183-158-228.us-west-1.compute.amazonaws.com```)
      - Paste it into a web browser URL and hit enter, you should be directed to and Apache2 Ubuntu Default Page and prints the message ```It works!```, followed by other configuration information
      - Navigate to ```/var/www/html``` and replace ```index.html``` with a new file named ```index.php``` and paste in this code:
```
<!DOCTYPE html>
<html>
<head>
        <title>Index</title>
</head>
<body>
        <h1>Index</h1>
</body>
</html>
<?php
echo "Index Page for Apache Server";
?>
```
## Install phpMyAdmin for MySQL GUI
1. Install phpMyAdmin for MySQL GUI
   - Type ```sudo apt-get update``` on command line and hit enter
   - Type ```sudo apt-get install phpmyadmin``` and hit enter
      - Type y and press enter when asked if you would like to continue
      - When prompted to choose a web server for reconfiguration, choose apache2 and hit enter
      - When asked whether you would like configure database for phpmyadmin with dbconfig-common, select yes and hit enter
      - Create a password for phpmyadmin (Use the same one as your mysql password for root user) and hit enter, then confirm password
   - Allow for apache access to phpmyadmin
      - Type ```sudo vim /etc/apache2/apache2.conf``` (or you can use a different text editor if you would like)  and hit enter
      - At the end of the file, create a new line and type ```Include /etc/phpmyadmin/apache.conf```
      - Save and exit
   - Restart apache by typing ```sudo systemctl restart apache2```
   - Test that all is working by returning to the browser page where you tested Apache connection, and adding ```/phpmyadmin``` to the end of the URL.  
      - For example: ```http://ec2-13-56-200-209.us-west-1.compute.amazonaws.com/phpmyadmin```
      - You should be redirected to a login page where you can login with username ```root``` and the password you created earlier, then login and you will be able to view a GUI of your MySQL Databases
1. Import MySQL Database into phpmyadmin
   - On your phpmyadmin GUI, create a new database and and name it ```Spoutlet```
   - Download   (ftp or with github) the file ```spoutlet2.sql``` from this [Google Drive folder](https://drive.google.com/drive/folders/0B_d8yXBizlAEaE9CNXdVWC1nSDg)
   - Return to your phpmyadmin page and open the ```Spoutlet``` database
   - Click ```import```, and then ```choose file```
      - Select the ```spoutlet2.sql``` file you downloaded and then finish the import by scrolling down and clicking “Go”
      - Results: Import has been successfully finished, 33 queries executed. (spoutlet2.sql)
   - Your ```Spoutlet``` database should now be populated with 6 tables (```comments```, ```events```, ```fos_user```, ```home```, ```sessions```, ```submission```), each with data in them already
   - Return to your terminal window for the next step
## Clone Spoutlet Github Repository on Instance  
   1. Navigate to Apache’s default web page directory by typing ```cd /var/www``` and pressing enter
   1. Return to the spoutlet2 github repository from step 7b (you will need a github account for the next step, create one if you don’t already have one)
   1. On the repository, click the green ```Clone of download``` button and copy the given url
   1. Return to your terminal window, you should still be navigated into the folder ```/var/www```
      - Type ```sudo git clone *copied-url*``` and hit enter (*url from step 8c)
``` 
sudo git clone https://github.com/dnielsen/spoutlet2.git 
```
      - Enter your github user information to finish cloning the repository
   1. After cloning the repository, type ```ls``` and hit enter, there should now be a ```spoutlet2``` directory present within /var/www
   1. Navigate into the new project directory by typing “cd spoutlet2” and hitting enter
   1. We will not be needing the ```spoutlet2.sql``` file, so delete it by typing ```sudo rm spoutlet2.sql``` and hitting enter
## Update Folder Permissions
1. Type ```sudo setfacl -R -m u:www-data:rX spoutlet2``` and hit enter
1. Type ```sudo setfacl -R -m u:www-data:rwX spoutlet2/app/cache spoutlet2/app/logs``` and hit enter
1. Type ```sudo setfacl -dR -m u:www-data:rwX spoutlet2/app/cache spoutlet2/app/logs``` and hit enter
1. Type ```export SYMFONY_ENV=prod``` and hit enter
## Update Spoutlet Project Requirements
1. Open and edit the file ```app/AppKernel.php``` in the spoutlet2 directory
   - cd spoutlet2
   - sudo vi app/AppKernel.php
   - and comment out the line ```$bundles[] = new Sensio\Bundle\GeneratorBundle\SensioGeneratorBundle();``` by adding two forward slashes in front of it  (```//```)
1. Update composer
   - Type ```sudo composer install --no-dev --optimize-autoloader``` and hit enter, this can take up to a few minutes
   - For all parameters, leave them blank and hit enter to accept the default, except for these:
   - For ```database_name``` enter *```Spoutlet```*
   - For ```database_password``` enter the password you created earlier
   - For ```mailer_transport``` enter *```gmail```*
   - For ```mailer_host``` enter *```smtp.gmail.com```*
   - For ```mailer_user``` enter a valid gmail email address
   - For ```mailer_password``` enter the email address’ respective password
   - For ```secret``` enter *```afb28c899101d12f6c5074bcef2fc2d0b0fa7084kk```*
1. Ensure MySQL, phpMyAdmin, and Symfony are all communicating correctly by typing “sudo php app/console doctrine:schema:validate” and hitting enter, you should see an output verifying that the mapping and database schema are all correct 
1. Clear cache by typing ```sudo php app/console cache:clear --env=prod --no-debug``` and hitting enter 
1. Generate assets with ```sudo php app/console assets:install --env=prod --no-debug```
## Change Default Apache Path to Spoutlet Web Page
1. Navigate to apache default path configuration by typing ```cd /etc/apache2/sites-available```
1. Type ```sudo mv 000-default.conf default.bkp.conf``` and hit enter
1. Open up a new file by typing ```sudo vim 000-default.conf```, then paste in this code:
```
<VirtualHost *:80>

    DocumentRoot /var/www/spoutlet2/web
    <Directory /var/www/spoutlet2/web>
        AllowOverride None
        Order Allow,Deny
        Allow from All

        <IfModule mod_rewrite.c>
            Options -MultiViews
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^(.*)$ app.php [QSA,L]
        </IfModule>
    </Directory>

    # uncomment the following lines if you install assets as symlinks
    # or run into problems when compiling LESS/Sass/CoffeScript assets
    # <Directory /var/www/project>
    #     Options FollowSymlinks
    # </Directory>

    ErrorLog /var/log/apache2/symfony_error.log
    CustomLog /var/log/apache2/symfony_access.log combined
</VirtualHost>
```
1. Save and exit
1. Enable module rewrite by typing ```sudo a2enmod rewrite``` and hitting enter
1. Restart apache with ```sudo systemctl restart apache2```
1. Open new web page and paste in the public DNS from step 5e, you should be directed to the Spoutlet2 Home Page
   - For example ```ec2-13-56-200-209.us-west-1.compute.amazonaws.com```


      
[Backup](http://bit.ly/2fTJxQ8)


   








      
      

      
      
      

